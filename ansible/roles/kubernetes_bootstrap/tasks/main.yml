---
- name: Kubernetes Bootstrap | set variables
  ansible.builtin.include_vars: '{{ item }}'
  tags:
    - kubernetes
    - kubernetes-bootstrap
    - argocd
    - core
    - openebs
    - infrastructure
    - apps
  with_first_found:
    - "{{ ansible_facts['os_family'] }}.yml"
    - default.yml

- name: Kubernetes Bootstrap | wait to allow cluster to fully come online
  ansible.builtin.command:
    cmd: kubectl wait --namespace=calico-system --for=condition=Ready pods --selector k8s-app=calico-node --timeout=15m
  run_once: true
  tags:
    - kubernetes
    - kubernetes-bootstrap
  when:
    - ansible_facts['os_family'] == 'Debian'
    - inventory_hostname in groups['k8s_controllers']

# ArgoCD
- name: ArgoCD
  ansible.builtin.import_tasks: argocd.yml
  tags:
    - kubernetes
    - kubernetes-bootstrap
    - argocd
  when:
    - ansible_facts['os_family'] == 'Debian'
    - inventory_hostname in groups['k8s_controllers']

# Core Apps
- name: Core
  ansible.builtin.import_tasks: core.yml
  tags:
    - kubernetes
    - kubernetes-bootstrap
    - core
  when:
    - ansible_facts['os_family'] == 'Debian'
    - inventory_hostname in groups['k8s_controllers']

# Infrastructure Apps
- name: Infrastructure
  ansible.builtin.import_tasks: infrastructure.yml
  tags:
    - kubernetes
    - kubernetes-bootstrap
    - infrastructure
  when:
    - ansible_facts['os_family'] == 'Debian'
    - inventory_hostname in groups['k8s_controllers']

# Apps Apps
- name: Apps
  ansible.builtin.import_tasks: apps.yml
  tags:
    - kubernetes
    - kubernetes-bootstrap
    - apps
  when:
    - ansible_facts['os_family'] == 'Debian'
    - inventory_hostname in groups['k8s_controllers']
