---
- name: kubernetes-bootstrap | set variables
  ansible.builtin.include_vars: '{{ item }}'
  tags:
    - kubernetes
    - kubernetes-bootstrap
    - argocd
    - core
    - core-openebs
    - infrastructure
    - apps
  with_first_found:
    - "{{ ansible_facts['os_family'] }}.yml"
    - default.yml

- name: kubernetes-bootstrap | pause to allow cluster to fully come online
  ansible.builtin.pause:
    seconds: 150
  tags:
    - kubernetes
    - kubernetes-bootstrap
  when:
    - ansible_facts['os_family'] == 'Debian'
    - inventory_hostname in groups['k8s_controllers']

# ArgoCD
- name: argocd
  ansible.builtin.import_tasks: argocd.yml
  tags:
    - kubernetes
    - kubernetes-bootstrap
    - argocd
  when:
    - ansible_facts['os_family'] == 'Debian'
    - inventory_hostname in groups['k8s_controllers']

# Core Apps
- name: core
  ansible.builtin.import_tasks: core.yml
  tags:
    - kubernetes
    - kubernetes-bootstrap
    - core
  when:
    - ansible_facts['os_family'] == 'Debian'
    - inventory_hostname in groups['k8s_controllers']

# Core OpenEBS
- name: core-openebs
  ansible.builtin.import_tasks: core-openebs.yml
  tags:
    - kubernetes
    - kubernetes-bootstrap
    - core-openebs
  when:
    - ansible_facts['os_family'] == 'Debian'
    - inventory_hostname in groups['k8s_controllers']

# Infrastructure Apps
- name: infrastructure
  ansible.builtin.import_tasks: infrastructure.yml
  tags:
    - kubernetes
    - kubernetes-bootstrap
    - infrastructure
  when:
    - ansible_facts['os_family'] == 'Debian'
    - inventory_hostname in groups['k8s_controllers']

# Apps Apps
- name: apps
  ansible.builtin.import_tasks: apps.yml
  tags:
    - kubernetes
    - kubernetes-bootstrap
    - apps
  when:
    - ansible_facts['os_family'] == 'Debian'
    - inventory_hostname in groups['k8s_controllers']
