---
- name: Kubeadm | create join token
  ansible.builtin.command:
    argv:
      - kubeadm
      - token
      - create
      - --print-join-command
      - --description
      - 'Generated by Ansible for Workers'
  delegate_to: "{{ groups['k8s_controllers'][0] }}"
  run_once: true
  register: kubernetes_join_token_cmd
  tags:
    - kubernetes
    - kubernetes-worker
    - kubeadm
  when:
    - ansible_facts['os_family'] == 'Debian'
    - inventory_hostname in groups['k8s_workers']

- name: Kubeadm | store join token
  ansible.builtin.add_host:
    name: k8s-dummy-host
    token_cmd: '{{ kubernetes_join_token_cmd.stdout }}'
  tags:
    - kubernetes
    - kubernetes-worker
    - kubeadm
  when:
    - ansible_facts['os_family'] == 'Debian'
    - inventory_hostname in groups['k8s_workers']

- name: Kubeadm | join workers
  ansible.builtin.command:
    cmd: "{{ hostvars['k8s-dummy-host']['token_cmd'] }} --ignore-preflight-errors '{{ kubernetes_kubeadm_ignore }}'"
  tags:
    - kubernetes
    - kubernetes-worker
    - kubeadm
  when:
    - ansible_facts['os_family'] == 'Debian'
    - inventory_hostname in groups['k8s_workers']
    - ansible_facts['services']['kubelet.service']['state'] == 'stopped'
